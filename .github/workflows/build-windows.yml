name: ðŸ—ï¸ Build OTClient Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite executar manualmente

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write  # NecessÃ¡rio para commit e releases
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: ðŸ“¦ Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'c8696863d371ab7f46e213d8f5ca923c4aef2a00'
        
    - name: ðŸ”§ Setup CMake e Ninja
      uses: lukka/get-cmake@latest
      
    - name: ðŸ—ï¸ Compilar OTClient
      uses: lukka/run-cmake@v10
      with:
        configurePreset: 'windows-release'
        buildPreset: 'windows-release'
        
    - name: ðŸ“¦ Preparar artefato
      run: |
        mkdir release-package
        copy build\windows-release\otclient.exe release-package\
        copy README_PROJETO74.md release-package\README.md
        echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
      shell: bash
        
    - name: ðŸ“¤ Upload executÃ¡vel (Artifact - 90 dias)
      uses: actions/upload-artifact@v4
      with:
        name: otclient-windows-x64
        path: release-package/
        retention-days: 90
        
    - name: ðŸš€ Commitar executÃ¡vel no repositÃ³rio
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Criar pasta bin se nÃ£o existir
        mkdir -p bin/windows
        
        # Comprimir executÃ¡vel (economiza espaÃ§o e evita limite de 100MB)
        7z a -tzip -mx9 bin/windows/otclient.zip build/windows-release/otclient.exe
        
        # Criar arquivo de informaÃ§Ãµes
        echo "ðŸŽ® OTClient Windows x64" > bin/windows/BUILD_INFO.txt
        echo "Compilado em: $(date)" >> bin/windows/BUILD_INFO.txt
        echo "Commit: ${{ github.sha }}" >> bin/windows/BUILD_INFO.txt
        echo "Branch: ${{ github.ref_name }}" >> bin/windows/BUILD_INFO.txt
        echo "Build: #${{ github.run_number }}" >> bin/windows/BUILD_INFO.txt
        echo "" >> bin/windows/BUILD_INFO.txt
        echo "âœ¨ OtimizaÃ§Ãµes:" >> bin/windows/BUILD_INFO.txt
        echo "- FPS padrÃ£o: 60" >> bin/windows/BUILD_INFO.txt
        echo "- Protocolo: 772" >> bin/windows/BUILD_INFO.txt
        echo "- Build: Release (otimizado)" >> bin/windows/BUILD_INFO.txt
        echo "" >> bin/windows/BUILD_INFO.txt
        echo "ðŸ“¥ Download:" >> bin/windows/BUILD_INFO.txt
        echo "- Descompacte otclient.zip" >> bin/windows/BUILD_INFO.txt
        echo "- Execute otclient.exe" >> bin/windows/BUILD_INFO.txt
        
        # Adicionar e commitar
        git add bin/windows/otclient.zip bin/windows/BUILD_INFO.txt
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-build #${{ github.run_number }}: ExecutÃ¡vel Windows atualizado [skip ci]"
        git push
      shell: bash
        
    - name: ðŸŽ‰ Criar Release automÃ¡tica
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: "Build #${{ github.run_number }} - Windows x64"
        body: |
          ## ðŸŽ® OTClient - Projeto 7.4 (Build AutomÃ¡tico)
          
          **ðŸ“… Data:** ${{ github.event.head_commit.timestamp }}  
          **ðŸ”¨ Commit:** ${{ github.sha }}  
          **ðŸ‘¤ Autor:** ${{ github.event.head_commit.author.name }}  
          
          ### âœ¨ OtimizaÃ§Ãµes incluÃ­das:
          - âœ… FPS padrÃ£o: 60 (reduz flicker visual)
          - âœ… Protocolo 772 estÃ¡vel
          - âœ… Compilado para Windows x64
          - âœ… Build Release otimizado
          
          ### ðŸ“¥ Como usar:
          1. Baixe `otclient.exe` abaixo
          2. Substitua na pasta do seu OTClient
          3. Configure `init.lua` para conectar em `192.168.0.36:7171:772`
          4. Execute e jogue!
          
          ### ðŸ”§ ConfiguraÃ§Ã£o do servidor (init.lua):
          ```lua
          Servers = {
              ["Nostalrius 7.72"] = "192.168.0.36:7171:772"
          }
          ALLOW_CUSTOM_SERVERS = true
          ```
          
          ### ðŸ“¦ TambÃ©m disponÃ­vel em:
          - **RepositÃ³rio:** `bin/windows/otclient.exe` (branch main)
          - **Artifact:** Aba "Actions" desta execuÃ§Ã£o
          
          ---
          
          ðŸ¤– *Build automÃ¡tico via GitHub Actions*
        files: |
          release-package/otclient.exe
          release-package/README.md
        draft: false
        prerelease: false
