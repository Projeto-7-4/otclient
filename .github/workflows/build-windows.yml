name: ðŸ—ï¸ Build OTClient Windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/build-windows.yml"

permissions:
  contents: write  # Para commit e releases

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 2
  MAKEFLAGS: "-j 2"

jobs:
  build:
    name: windows-release
    runs-on: windows-2022

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Get vcpkg commit ID
        id: vcpkg-step
        shell: pwsh
        run: |
          $json = Get-Content vcpkg.json -Raw | ConvertFrom-Json
          $commit = $json.'builtin-baseline'
          echo "vcpkgGitCommitId=$commit" >> $env:GITHUB_OUTPUT

      - name: ðŸ“Š Compute vcpkg.json hash
        id: hash
        shell: pwsh
        run: |
          $json = Get-Content "vcpkg.json" -Raw -Encoding UTF8
          $bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
          $sha256 = [System.Security.Cryptography.SHA256]::Create()
          $hashBytes = $sha256.ComputeHash($bytes)
          $hash = [BitConverter]::ToString($hashBytes) -replace '-', ''
          "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: ðŸ’¾ Cache vcpkg artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/buildtrees
            ${{ github.workspace }}/vcpkg/downloads
          key: vcpkg-windows-2022-windows-release-${{ steps.hash.outputs.hash }}
          restore-keys: |
            vcpkg-windows-2022-windows-release-

      - name: ðŸ—‘ï¸ Remove Windows pre-installed MySQL
        run: Remove-Item -Recurse -Force -ErrorAction SilentlyContinue "C:/mysql*"

      - name: ðŸ“¦ Install vcpkg
        uses: lukka/run-vcpkg@a400452f634fe49e9f18d388aeb1809dcc642136
        with:
          vcpkgGitCommitId: ${{ steps.vcpkg-step.outputs.vcpkgGitCommitId }}

      - name: ðŸ”§ Get latest CMake and Ninja
        uses: lukka/get-cmake@v3.31.6

      - name: ðŸ—ï¸ Configure and Build
        uses: lukka/run-cmake@main
        with:
          configurePreset: 'windows-release'
          buildPreset: 'windows-release'

      - name: ðŸ“¦ Prepare artifact folder
        shell: pwsh
        run: |
          $artifactDir = "$env:GITHUB_WORKSPACE\artifacts"
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null

          $exePath = Get-ChildItem -Recurse -Path $env:GITHUB_WORKSPACE -Filter "otclient*.exe" | Select-Object -First 1

          if (-not $exePath) {
            Write-Error "Not found otclient*.exe!"
            exit 1
          }

          Copy-Item $exePath.FullName -Destination $artifactDir

          $dlls = Get-ChildItem -Path $exePath.Directory.FullName -Filter "*.dll"
          foreach ($dll in $dlls) {
            Copy-Item $dll.FullName -Destination $artifactDir
          }

      - name: ðŸ“¤ Upload Artifact (90 dias)
        uses: actions/upload-artifact@v4
        with:
          name: otclient-windows-x64
          path: ${{ github.workspace }}/artifacts

      - name: ðŸš€ Commitar executÃ¡vel no repositÃ³rio
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          mkdir -p bin/windows
          
          # Comprimir executÃ¡vel
          cd artifacts
          7z a -tzip -mx9 ../bin/windows/otclient.zip *
          cd ..
          
          # Criar BUILD_INFO
          cat > bin/windows/BUILD_INFO.txt << EOF
          ðŸŽ® OTClient Windows x64
          Compilado em: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Build: #${{ github.run_number }}
          
          âœ¨ OtimizaÃ§Ãµes:
          - FPS padrÃ£o: 60
          - Protocolo: 772
          - Build: Release (otimizado)
          
          ðŸ“¥ Download:
          - Descompacte otclient.zip
          - Execute otclient.exe
          EOF
          
          git add bin/windows/otclient.zip bin/windows/BUILD_INFO.txt
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-build #${{ github.run_number }}: ExecutÃ¡vel Windows atualizado [skip ci]"
          git push

      - name: ðŸŽ‰ Criar Release automÃ¡tica
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Build #${{ github.run_number }} - Windows x64"
          body: |
            ## ðŸŽ® OTClient - Projeto 7.4 (Build AutomÃ¡tico)
            
            **ðŸ“… Compilado:** ${{ github.event.head_commit.timestamp }}  
            **ðŸ”¨ Commit:** ${{ github.sha }}  
            
            ### âœ¨ OtimizaÃ§Ãµes incluÃ­das:
            - âœ… FPS padrÃ£o: 60 (reduz flicker visual)
            - âœ… Protocolo 772 estÃ¡vel
            - âœ… Compilado para Windows x64
            - âœ… Build Release otimizado
            
            ### ðŸ“¥ Como usar:
            1. Baixe `otclient.zip` abaixo
            2. Extraia o arquivo
            3. Copie para pasta do seu OTClient
            4. Execute `otclient.exe` e jogue!
            
            ### ðŸ”§ ConfiguraÃ§Ã£o do servidor (init.lua):
            ```lua
            Servers = {
                ["Nostalrius 7.72"] = "192.168.0.36:7171:772"
            }
            ```
          files: |
            bin/windows/otclient.zip
          draft: false
          prerelease: false
